#!/bin/sh -x
wifi=wlan0
iface=@wifi-iface[0]
radio=$(uci get wireless.${iface}.device)
connect_wifi(){
    # channel ssid encryption key
    uci set wireless.${iface}.mode=sta

    ifconfig $wifi up
    uci set wireless.${radio}.channel=$1
    uci set "wireless.${iface}.ssid=$2"
    if [ $3 == "none" ] ; then
        uci set wireless.${iface}.encryption=none
        uci -q delete wireless.${iface}.key
    else
        uci set "wireless.${iface}.key=$4"
        uci set wireless.${iface}.encryption=$3
    fi 
    uci commit wireless
    wifi up
}

iwlist_scan(){
    count=0
    
    iwlist scan ${1:-} 2>/dev/null | ( while read line;
    do
        case "$line" in
            *"Cell "*)
                #echo
                : $((count+=1))
                echo MAC_${count}="${line#*Address: }"
                ;;
            *Channel:*)
                echo CHANNEL_${count}="${line#*:}"
                ;;
            *Quality=*)
                echo QUALITY_${count}="`printf '%s' ${line#*Quality=} | cut -d/  -f 1`"
                ;;
            *"Encryption key:"*)
                echo ENCRYPTION_${count}="${line#*key:}"
                ;;
            *ESSID:*)
                echo ESSID_${count}="${line#*ESSID:}"
                ;;
            *"IE: IEEE 802.11i/WPA2"*)
                echo WPA2_${count}=1
                ;;
            *"IE: WPA Version 1"*)
                echo WPA_${count}=1
                ;;
            *);;
        esac
    done; echo WIFI_COUNT=$count)
}
crack_wifi(){
    for hack in $(ls /usr/lib/autowifi/); do
        key=$($hack $@);
        if ! [ $key -eq 1 ];then
            break
        else
            connect_wifi $3 $1 
        fi
    done
}
check_internet(){
    wget -O- --spider http://google.de/index.html
}
loop_over_networks(){
    . /tmp/${wifi}.scan
    for i in `seq 1 $WIFI_COUNT`; do
        crack_wifi \${ESSID_${i}} \${MAC_${i}} \${CHANNEL_${i}} \${ENCRYPTION_${i}} \${WPA_${i}} \${WPA2_${i}}
    done

}

iwlist_scan > /tmp/${wifi}.scan
loop_over_networks

